version: 2.1

executors:
  multiimage:
    docker:
      - image: cimg/base:current
      - image: postgres:13.10
        environment:
          POSTGRES_DB: wiki
          POSTGRES_USER: Free
          POSTGRES_PASSWORD: Willy
      - image: redis:7.4-rc-alpine
    resource_class: large

jobs:
  multiimage:
    executor: multiimage
    steps:
      - setup_remote_docker:
          docker_layer_caching: false
      - run: docker ps
      - run:
          name: find pause container
          command: |
            CNTR_ID_PAUSE=$(docker container ls --filter="ancestor=public.ecr.aws/eks-distro/kubernetes/pause:3.6" --quiet)
            echo "export CNTR_ID_PAUSE=${CNTR_ID_PAUSE}" >> $BASH_ENV
      - run:
          name: kill pause container
          command: |
            docker kill $CNTR_ID_PAUSE

workflows:
  explore:
    jobs:
      - multiimage
